<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Assignment Frontend</title>
  <style>
    body{font-family:Arial;max-width:900px;margin:2rem auto;padding:1rem;}
    input, textarea{display:block;margin:8px 0;padding:8px;width:100%;}
    .card{border:1px solid #ddd;padding:12px;margin:8px 0;border-radius:6px;}
    button{padding:8px 12px;margin-right:6px;}
    .error{color:#b12704;}
  </style>
</head>
<body>
  <h1>Assignment Demo</h1>

  <div id="auth">
    <h2>Register</h2>
    <input id="reg_username" placeholder="username" />
    <input id="reg_email" placeholder="email" />
    <input id="reg_password" type="password" placeholder="password" />
    <select id="reg_role">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="register()">Register</button>
    <div id="reg_msg"></div>

    <h2>Login</h2>
    <input id="login_username" placeholder="username" />
    <input id="login_password" type="password" placeholder="password" />
    <button onclick="login()">Login</button>
    <div id="login_msg"></div>
  </div>

  <hr/>

  <div id="app" style="display:none;">
    <h2>Dashboard</h2>
    <div>
      <button onclick="logout()">Logout</button>
      <span id="who"></span>
    </div>

    <h3>Create Task</h3>
    <input id="task_title" placeholder="Title"/>
    <textarea id="task_desc" placeholder="Description"></textarea>
    <select id="task_status">
      <option value="todo">To Do</option>
      <option value="in_progress">In Progress</option>
      <option value="done">Done</option>
    </select>
    <button onclick="createTask()">Create</button>

    <h3>Your Tasks</h3>
    <div id="tasks"></div>
  </div>

<script>
const API = "http://127.0.0.1:8000/api/v1";

function setMsg(id, msg, isError=false){
  const el = document.getElementById(id);
  el.innerText = msg;
  el.className = isError ? "error" : "";
}

function register(){
  const username = document.getElementById("reg_username").value;
  const email = document.getElementById("reg_email").value;
  const password = document.getElementById("reg_password").value;
  const role = document.getElementById("reg_role").value;
  fetch(API + "/auth/register/", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username,email,password,role})
  }).then(r=>r.json()).then(data=>{
    if (data.id) setMsg("reg_msg","Registered. Now login.");
    else setMsg("reg_msg", JSON.stringify(data), true);
  }).catch(e => setMsg("reg_msg", e.message, true));
}

function login(){
  const username = document.getElementById("login_username").value;
  const password = document.getElementById("login_password").value;
  fetch(API + "/auth/login/", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username,password})
  }).then(r=>r.json()).then(data=>{
    if (data.access){
      localStorage.setItem("access", data.access);
      localStorage.setItem("refresh", data.refresh);
      showApp();
    } else {
      setMsg("login_msg", JSON.stringify(data), true);
    }
  }).catch(e => setMsg("login_msg", e.message, true));
}

function logout(){
  localStorage.removeItem("access");
  localStorage.removeItem("refresh");
  document.getElementById("app").style.display = "none";
  document.getElementById("auth").style.display = "block";
}

function getAuthHeaders(){
  const token = localStorage.getItem("access");
  return { "Content-Type":"application/json", "Authorization": "Bearer " + token };
}

function showApp(){
  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";
  fetchUserAndTasks();
}

function fetchUserAndTasks(){
  const headers = getAuthHeaders();
  fetch(API + "/tasks/", { headers }).then(r=>r.json()).then(tasks=>{
    renderTasks(tasks);
  }).catch(e => {
    console.error(e);
    logout();
    alert("Session expired. Login again.");
  });

  // decode token (basic)
  const token = localStorage.getItem("access");
  if(token){
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById("who").innerText = `Logged in as ${payload.username} (${payload.role})`;
  }
}

function createTask(){
  const title = document.getElementById("task_title").value;
  const description = document.getElementById("task_desc").value;
  const status = document.getElementById("task_status").value;
  const headers = getAuthHeaders();
  fetch(API + "/tasks/", {
    method:"POST",
    headers,
    body: JSON.stringify({title,description,status})
  }).then(r=>r.json()).then(data=>{
    if(data.id) {
      fetchUserAndTasks();
    } else {
      alert(JSON.stringify(data));
    }
  });
}

function renderTasks(tasks){
  const container = document.getElementById("tasks");
  container.innerHTML = "";
  if(!Array.isArray(tasks)){
    container.innerText = JSON.stringify(tasks);
    return;
  }
  tasks.forEach(t=>{
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${t.title}</b> (<i>${t.status}</i>)<p>${t.description}</p>
      <small>Owner: ${t.owner.username}</small><br/>
      <button onclick='edit(${t.id})'>Edit</button>
      <button onclick='del(${t.id})'>Delete</button>
    `;
    container.appendChild(d);
  });
}

function del(id){
  if(!confirm("Delete?")) return;
  fetch(API + `/tasks/${id}/`, {
    method:"DELETE",
    headers: getAuthHeaders()
  }).then(r=>{
    if(r.status === 204) fetchUserAndTasks();
    else r.json().then(d => alert(JSON.stringify(d)));
  });
}

function edit(id){
  const title = prompt("New title?");
  if(title===null) return;
  const description = prompt("New description?");
  const status = prompt("Status (todo,in_progress,done)", "todo");
  fetch(API + `/tasks/${id}/`, {
    method:"PUT",
    headers: getAuthHeaders(),
    body: JSON.stringify({title, description, status})
  }).then(r=>r.json()).then(d=>{
    if(d.id) fetchUserAndTasks();
    else alert(JSON.stringify(d));
  });
}

// Auto-show app if token exists
if(localStorage.getItem("access")){
  showApp();
}
</script>
</body>
</html>
